<meta charset="utf-8">
<script src="jquery-3.6.1.slim.min.js"></script>
<script src="luxon.min.js"></script>

<style>
@font-face {
  font-family: frontpage;
  src: url('frontpageneue.otf') format('opentype');
}
* {
  box-sizing: border-box;
}
body {
  margin: 0;
  padding: 0;
  background: #000;
  font-family: frontpage;
  font-size: 96px;
  line-height: 1;
}
#controls {
  position: absolute;
  right: 0;
  text-align: right;
  display: flex;
  flex-direction: column;
}
section {
  margin: 0;
  padding: 0;
  display: flex;
  position: absolute;
}
#top {
  left: 0;
  top: 0;
}
#bottom {
  left: 500;
  top: 0;
}
.row {
  transition: opacity 300ms;
  white-space: pre;
}
.widget {
  white-space: normal;
}
.hidden {
  opacity: 0;
  transition: none;
}
.omitted {
  display: none;
}
.panel {
  padding: 12px;
  text-align: center;
}
.panel.left {
  background: #222;
}
.panel.right {
  background: #333;
}
.top.panel {
  width: 208px;
  height: 832px;
}
.bottom.panel {
  width: 416px;
  height: 1040px;
  overflow: hidden;
  color: white;
}
.digit {
  display: inline-block;
  width: 1ch;
  text-align: center;
}
.panel[theme='red'] {
  background: #eb1c23;
}
.panel[theme='blue'] {
  background: #4aa1cc;
}
.panel[theme='red-sm'] {
  background: #eb1c23;
  font-size: 78px;
}
.panel[theme='blue-sm'] {
  background: #4aa1cc;
  font-size: 78px;
}
.strike {
  text-decoration: line-through;
}
#num-years, #num-days, #percent-part1, #indigenous-part1, #loss-part1 {
  font-size: 220px;
  height: 192px;
}
#label-days {
  margin-bottom: 48px;
}
.time-part {
  text-align: left;
  padding-left: 84px;
}
#indigenous-part3 {
  height: 96px;
  margin: -18px 0 66px 0;
}
#loss-part3 {
  margin-bottom: 48px;
}
</style>

<body>
  <div id="controls">
    <button onclick='document.fullscreenElement ? document.exitFullscreen() : document.body.requestFullscreen()' type=button>Full screen</button>
    <button onclick='fi = -1; nextFrameMillis = Date.now()' type=button>Restart</button>
    <button onclick='fi = (fi + frames.length - 2) % frames.length; nextFrameMillis = Date.now()' type=button>Previous</button>
    <button onclick='nextFrameMillis = Date.now() + 3600*1000' type=button>Stay</button>
    <button onclick='nextFrameMillis = Date.now()' type=button>Next</button>
  </div>
  <section id=top>
    <div id="top-left" class="panel top left">
    </div>
    <div id="top-right" class="panel top right">
    </div>
  </section>

  <section id=bottom>
    <div id="bottom-left" class="panel bottom left">
    </div>
    <div id="bottom-right" class="panel bottom right">
    </div>
  </section>

  <div id="widgets" class="omitted">
    <div id="deadline-widget" class="widget">
      <div id="num-years"></div>
      <div id="label-years" class="lg">YEARS</div>
      <div id="num-days">
        <span id="days-100" class="digit"></span><span id="days-10" class="digit"></span><span id="days-1" class="digit"></span>
      </div>
      <div id="label-days" class="lg">DAYS</div>
      <div id="hours" class="time-part">
        <span id="hours-10" class="digit"></span><span id="hours-1" class="digit"></span> <span id="label-hours">HRS</span>
      </div>
      <div id="minutes" class="time-part">
        <span id="minutes-10" class="digit"></span><span id="minutes-1" class="digit"></span> <span id="label-minutes">MIN</span>
      </div>
      <div id="seconds" class="time-part">
        <span id="seconds-10" class="digit"></span><span id="seconds-1" class="digit"></span> <span id="label-seconds">SEC</span>
      </div>
    </div>

    <div id="renewables-widget" class="widget">
      <div id="percent-part1">
        <span id="percent-10" class="digit"></span><span id="percent-1" class="digit"></span>.
      </div>
      <div id="percent-part2">
        <span id="percent-01" class="digit"></span><span id="percent-001" class="digit"></span><span id="percent-0001" class="digit"></span><span id="percent-00001" class="digit"></span><span id="percent-000001" class="digit"></span>
      </div>
      <div id="percent-part3">
        <span id="percent-0000001" class="digit"></span><span id="percent-00000001" class="digit"></span><span id="percent-000000001" class="digit"></span><span id="percent-0000000001" class="digit"></span>
      </div>
    </div>

    <div id="indigenous-land-widget" class="widget">
      <div id="indigenous-part1">43.5</div>
      <div id="indigenous-part2">MILLION</div>
      <div id="indigenous-part3">KM<sup>2</sup></div>
    </div>

    <div id="loss-damage-widget" class="widget">
      <div id="loss-part1">
        $<span id="loss-10000000000000" class="digit"></span><span id="loss-1000000000000" class="digit"></span>,
      </div>
      <div id="loss-part2">
        <span id="loss-100000000000" class="digit"></span><span id="loss-10000000000" class="digit"></span><span id="loss-1000000000" class="digit"></span>,<span id="loss-100000000" class="digit"></span><span id="loss-10000000" class="digit"></span><span id="loss-1000000" class="digit"></span>,
      </div>
      <div id="loss-part3">
        <span id="loss-100000" class="digit"></span><span id="loss-10000" class="digit"></span><span id="loss-1000" class="digit"></span>,<span id="loss-100" class="digit"></span><span id="loss-10" class="digit"></span><span id="loss-1" class="digit"></span>
      </div>
    </div>

  </div>
</body>

<script>
var DEADLINE = luxon.DateTime.fromISO('2029-07-22T16:00:00Z');

var deadlineWidget = $('#deadline-widget');
var deadlineNumYears = $('#num-years');
var deadlineDays = [$('#days-1'), $('#days-10'), $('#days-100')];
var deadlineLabelDays = $('#label-days');
var deadlineHours = [$('#hours-1'), $('#hours-10')];
var deadlineLabelHours = $('#label-hours');
var deadlineMinutes = [$('#minutes-1'), $('#minutes-10')];
var deadlineSeconds = [$('#seconds-1'), $('#seconds-10')];

var renewablesWidget = $('#renewables-widget');
var renewablesPercentWholePart = [$('#percent-1'), $('#percent-10')];
var renewablesPercentFractionalPart = [
  $('#percent-0000000001'),
  $('#percent-000000001'),
  $('#percent-00000001'),
  $('#percent-0000001'),
  $('#percent-000001'),
  $('#percent-00001'),
  $('#percent-0001'),
  $('#percent-001'),
  $('#percent-01'),
];

var indigenousLandWidget = $('#indigenous-land-widget');

var lossDamageWidget = $('#loss-damage-widget');
var lossDamageDigits = [
  $('#loss-1'),
  $('#loss-10'),
  $('#loss-100'),
  $('#loss-1000'),
  $('#loss-10000'),
  $('#loss-100000'),
  $('#loss-1000000'),
  $('#loss-10000000'),
  $('#loss-100000000'),
  $('#loss-1000000000'),
  $('#loss-10000000000'),
  $('#loss-100000000000'),
  $('#loss-1000000000000'),
  $('#loss-10000000000000')
];

function setDigits(value, elements) {
  for (var element of elements) {
    element.text(value % 10);
    value = Math.floor(value / 10);
  }
}

function deadline(row) {
  if (row.children().length == 0) {
    row.append(deadlineWidget);
  }
  var now = luxon.DateTime.utc();
  var nextAnniversary = DEADLINE.set({year: now.year});
  if (nextAnniversary < now) {
    nextAnniversary = DEADLINE.set({year: now.year + 1});
  }
  var years = DEADLINE.year - nextAnniversary.year;
  var t = nextAnniversary.toMillis() - now.toMillis();
  t = Math.floor(t / 1000);
  var s = t % 60;
  t = Math.floor(t / 60);
  var m = t % 60;
  t = Math.floor(t / 60);
  var h = t % 24;
  var d = Math.floor(t / 24);

  deadlineNumYears.text(years);
  setDigits(d, deadlineDays);
  deadlineLabelDays.text((d == 1) ? 'DAY' : 'DAYS');
  setDigits(h, deadlineHours);
  console.log('hours', h);
  deadlineLabelHours.text((h == 1) ? 'HR' : 'HRS');
  setDigits(m, deadlineMinutes);
  setDigits(s, deadlineSeconds);
}

function linearGrowth(spec) {
  var elapsed = BigInt(Date.now() - spec.refMillis);
  var value = spec.initial + spec.rate * elapsed / 1000n + spec.bias;
  var strValue = '0'.repeat(spec.shift) + String(value);
  var wholePart = strValue.substr(0, strValue.length - spec.shift);
  var fractionalPart = strValue.substr(-spec.shift).substr(0, spec.decimals);
  return wholePart.replace(/^0+/, '') + '.' + fractionalPart;
}

var RENEWABLES = {
  refMillis: luxon.DateTime.fromISO('2020-01-01T00:00:00Z').toMillis(),

  initial: 11400000000000000000000000n,
  rate: 20428359571070087n,

  decimals: 9,
  shift: 24
};
RENEWABLES.bias = 5n * 10n**BigInt(RENEWABLES.shift - RENEWABLES.decimals - 1);

function renewables(row) {
  if (row.children().length == 0) {
    row.append(renewablesWidget);
  }
  var value = linearGrowth(RENEWABLES);
  var [whole, fractional] = value.split('.');
  setDigits(whole - 0, renewablesPercentWholePart);
  setDigits(fractional - 0, renewablesPercentFractionalPart);
}

function indigenousLand(row) {
  if (row.children().length == 0) {
    row.append(indigenousLandWidget);
  }
}

var LOSS_DAMAGE = {
  refMillis: luxon.DateTime.fromISO('2020-01-01T00:00:00Z').toMillis(),

  initial: 297540000000000000000000n,
  rate: 471408520521309n,

  decimals: 0,
  shift: 10
};
LOSS_DAMAGE.bias = 5n * 10n**BigInt(LOSS_DAMAGE.shift - LOSS_DAMAGE.decimals - 1);


function lossAndDamage(row) {
  if (row.children().length == 0) {
    row.append(lossDamageWidget);
  }
  var value = linearGrowth(LOSS_DAMAGE);
  var [whole, fractional] = value.split('.');
  setDigits(whole - 0, lossDamageDigits);
}

const frames = [
  {
    duration: 10,
    left: {theme: 'red-sm', rows: ['#ClimateClock']},
    right: {theme: 'blue-sm', rows: ['#ActInTime']}
  },
  {
    duration: 10,
    left: {theme: 'red', rows: ['THE', 'SCIENCE', 'IS', 'CLEAR']},
    right: {theme: 'blue', rows: ['OUR', 'CARBON', 'BUDGET', 'IS', 'RUNNING', 'OUT']}
  },
  {
    duration: 10,
    left: {theme: 'red', rows: ['WE', 'HAVE', 'LESS', 'THAN', '7', 'YEARS']},
    right: {theme: 'blue', rows: ['TO', 'PROTECT', 'OUR PLANET', '& PEOPLE']}
  },
  {
    duration: 10,
    left: {theme: 'red', rows: ['DELAY', '=', 'DENIAL']},
    right: {theme: 'blue', rows: ['WE MUST', 'END', 'FOSSIL', 'FUELS', 'BY', '/2070', '/2060', '/2050', '/2040', '2030']}
  },
  {
    duration: 10,
    left: {theme: 'red', rows: ['DEADLINE', deadline]},
    right: {theme: 'red', rows: ['OUR', 'WINDOW', 'OF', 'HOPE', ' ', 'LET\'S', '#ActInTime']}
  },

  {
    duration: 10,
    left: {theme: 'red', rows: ['THE', 'EARTH', 'HAS A', 'DEADLINE']},
    right: {theme: 'blue', rows: ['BUT', 'WE HAVE', 'MANY', 'LIFELINES']}
  },
  {
    duration: 10,
    left: {theme: 'red', rows: ['SOLUTIONS', 'EXIST']},
    right: {theme: 'blue', rows: ['WE CAN', 'BUILD A', 'JUST &', 'LIVABLE', 'WORLD']}
  },
  {
    duration: 10,
    left: {theme: 'red', rows: ['PRESIDENTS,', 'MINISTERS,', 'NEGOTIATORS,', 'DELEGATES...', 'BE BOLD!']},
    right: {theme: 'blue', rows: ['THE', 'FUTURE', 'IS COUNTING', 'ON YOU...']}
  },
  {
    duration: 10,
    left: {theme: 'red', rows: ['THE EYES', 'OF THE', 'WORLD', 'ARE ON', 'COP27']},
    right: {theme: 'blue', rows: ['/BLAH', '/BLAH', '/BLAH', 'COURAGE', 'JUSTICE', 'SPEED']}
  },
  {
    duration: 10,
    left: {theme: 'red-sm', rows: ['#ClimateClock']},
    right: {theme: 'blue-sm', rows: ['#ActInTime']}
  },


  {
    duration: 10,
    left: {theme: 'blue', rows: ['LIFELINE', renewables, '%', 'OF WORLD\'S', 'ENERGY', 'FROM', 'RENEWABLES']},
    right: {theme: 'blue', rows: ['WE MUST', 'ACHIEVE', '100%', 'RENEWABLES', 'BEFORE', '2030', 'TO STAY', 'BELOW', '1.5° C']}
  },
  {
    duration: 10,
    left: {theme: 'blue', rows: ['LIFELINE', indigenousLand, 'LAND', 'PROTECTED', 'BY', 'INDIGENOUS', 'PEOPLE']},
    right: {theme: 'blue', rows: ['INDIGENOUS', 'LANDS IN', 'INDIGENOUS', 'HANDS', 'IS A KEY', 'CLIMATE', 'SOLUTION']}
  },
  {
    duration: 10,
    left: {theme: 'blue', rows: ['LIFELINE', lossAndDamage, 'LOSS &', 'DAMAGE', 'OWED', 'BY G20']},
    right: {theme: 'blue', rows: ['THE BIGGEST', 'POLLUTERS', 'MUST PAY', 'THOSE', 'MOST', 'IMPACTED']}
  },
  {
    duration: 10,
    left: {theme: 'red', rows: ['DEADLINE', deadline]},
    right: {theme: 'red', rows: ['THIS IS', 'OUR', 'WINDOW', 'OF HOPE', ' ', 'LET\'S', '#ActInTime']}
  },

  {
    duration: 10,
    left: {theme: 'blue', rows: ['LIFELINE', renewables, '%', 'OF WORLD\'S', 'ENERGY', 'FROM', 'RENEWABLES']},
    right: {theme: 'blue', rows: ['WE MUST', 'ACHIEVE', '100%', 'RENEWABLES', 'BEFORE', '2030', 'TO STAY', 'BELOW', '1.5° C']}
  },
  {
    duration: 10,
    left: {theme: 'blue', rows: ['LIFELINE', indigenousLand, 'LAND', 'PROTECTED', 'BY', 'INDIGENOUS', 'PEOPLE']},
    right: {theme: 'blue', rows: ['INDIGENOUS', 'LANDS IN', 'INDIGENOUS', 'HANDS', 'IS A KEY', 'CLIMATE', 'SOLUTION']}
  },
  {
    duration: 10,
    left: {theme: 'blue', rows: ['LIFELINE', lossAndDamage, 'LOSS &', 'DAMAGE', 'OWED', 'BY G20']},
    right: {theme: 'blue', rows: ['THE BIGGEST', 'POLLUTERS', 'MUST PAY', 'THOSE', 'MOST', 'IMPACTED']}
  },
  {
    duration: 10,
    left: {theme: 'red', rows: ['DEADLINE', deadline]},
    right: {theme: 'red', rows: ['THIS IS', 'OUR', 'WINDOW', 'OF HOPE', ' ', 'LET\'S', '#ActInTime']}
  },

  {
    duration: 10,
    left: {theme: 'blue', rows: ['LIFELINE', renewables, '%', 'OF WORLD\'S', 'ENERGY', 'FROM', 'RENEWABLES']},
    right: {theme: 'blue', rows: ['WE MUST', 'ACHIEVE', '100%', 'RENEWABLES', 'BEFORE', '2030', 'TO STAY', 'BELOW', '1.5° C']}
  },
  {
    duration: 10,
    left: {theme: 'blue', rows: ['LIFELINE', indigenousLand, 'LAND', 'PROTECTED', 'BY', 'INDIGENOUS', 'PEOPLE']},
    right: {theme: 'blue', rows: ['INDIGENOUS', 'LANDS IN', 'INDIGENOUS', 'HANDS', 'IS A KEY', 'CLIMATE', 'SOLUTION']}
  },
  {
    duration: 10,
    left: {theme: 'blue', rows: ['LIFELINE', lossAndDamage, 'LOSS &', 'DAMAGE', 'OWED', 'BY G20']},
    right: {theme: 'blue', rows: ['THE BIGGEST', 'POLLUTERS', 'MUST PAY', 'THOSE', 'MOST', 'IMPACTED']}
  },
  {
    duration: 10,
    left: {theme: 'red', rows: ['DEADLINE', deadline]},
    right: {theme: 'red', rows: ['THIS IS', 'OUR', 'WINDOW', 'OF HOPE', ' ', 'LET\'S', '#ActInTime']}
  },

  {
    duration: 10,
    left: {theme: 'blue', rows: ['LIFELINE', renewables, '%', 'OF WORLD\'S', 'ENERGY', 'FROM', 'RENEWABLES']},
    right: {theme: 'blue', rows: ['WE MUST', 'ACHIEVE', '100%', 'RENEWABLES', 'BEFORE', '2030', 'TO STAY', 'BELOW', '1.5° C']}
  },
  {
    duration: 10,
    left: {theme: 'blue', rows: ['LIFELINE', indigenousLand, 'LAND', 'PROTECTED', 'BY', 'INDIGENOUS', 'PEOPLE']},
    right: {theme: 'blue', rows: ['INDIGENOUS', 'LANDS IN', 'INDIGENOUS', 'HANDS', 'IS A KEY', 'CLIMATE', 'SOLUTION']}
  },
  {
    duration: 10,
    left: {theme: 'blue', rows: ['LIFELINE', lossAndDamage, 'LOSS &', 'DAMAGE', 'OWED', 'BY G20']},
    right: {theme: 'blue', rows: ['THE BIGGEST', 'POLLUTERS', 'MUST PAY', 'THOSE', 'MOST', 'IMPACTED']}
  },
  {
    duration: 10,
    left: {theme: 'red', rows: ['DEADLINE', deadline]},
    right: {theme: 'red', rows: ['THIS IS', 'OUR', 'WINDOW', 'OF HOPE', ' ', 'LET\'S', '#ActInTime']}
  },

  {
    duration: 10,
    left: {theme: 'blue', rows: ['LIFELINE', renewables, '%', 'OF WORLD\'S', 'ENERGY', 'FROM', 'RENEWABLES']},
    right: {theme: 'blue', rows: ['WE MUST', 'ACHIEVE', '100%', 'RENEWABLES', 'BEFORE', '2030', 'TO STAY', 'BELOW', '1.5° C']}
  },
  {
    duration: 10,
    left: {theme: 'blue', rows: ['LIFELINE', indigenousLand, 'LAND', 'PROTECTED', 'BY', 'INDIGENOUS', 'PEOPLE']},
    right: {theme: 'blue', rows: ['INDIGENOUS', 'LANDS IN', 'INDIGENOUS', 'HANDS', 'IS A KEY', 'CLIMATE', 'SOLUTION']}
  },
  {
    duration: 10,
    left: {theme: 'blue', rows: ['LIFELINE', lossAndDamage, 'LOSS &', 'DAMAGE', 'OWED', 'BY G20']},
    right: {theme: 'blue', rows: ['THE BIGGEST', 'POLLUTERS', 'MUST PAY', 'THOSE', 'MOST', 'IMPACTED']}
  },
  {
    duration: 10,
    left: {theme: 'red', rows: ['DEADLINE', deadline]},
    right: {theme: 'red', rows: ['THIS IS', 'OUR', 'WINDOW', 'OF HOPE', ' ', 'LET\'S', '#ActInTime']}
  },

];

var fi = -1;
var startFrameMillis = 0;
var nextFrameMillis = 0;
var si = 0;
var panels = {
  left: {
    node: $('#bottom-left'),
    rows: [],
  },
  right: {
    node: $('#bottom-right'),
    rows: [],
  }
};

function tick() {
  var now = Date.now();
  if (now > nextFrameMillis) {
    fi = (fi + 1) % frames.length;
    startFrameMillis = (nextFrameMillis > now - 1000) ? nextFrameMillis : now;
    nextFrameMillis = startFrameMillis + frames[fi].duration * 1000;
    for (var ri = 0; ri < panels.left.rows.length; ri++) {
      panels.left.rows[ri].empty();
    }
    for (var ri = 0; ri < panels.right.rows.length; ri++) {
      panels.right.rows[ri].empty();
    }
    console.log('frame:', frames[fi].left.rows, frames[fi].right.rows);
  }
  si = 1;
  drawPanel(panels.left, frames[fi].left, now - startFrameMillis);
  si += 2;
  drawPanel(panels.right, frames[fi].right, now - startFrameMillis);
  setTimeout(tick, 20);
}

function drawPanel(panel, frame, millis) {
  while (panel.rows.length < frame.rows.length) {
    panel.rows.push($('<div>').addClass('row').appendTo(panel.node));
  }
  var revealed = millis / 500;
  for (var ri = 0; ri < panel.rows.length; ri++) {
    var content = frame.rows[ri] || '';
    if (typeof content == 'function') {
      content(panel.rows[ri]);
    } else {
      var strike = false;
      if (content.startsWith('/')) {
        content = content.substring(1);
        strike = true;
      }
      panel.rows[ri].empty();
      panel.rows[ri].text(content);
      panel.rows[ri].toggleClass('strike', strike);
    }
    panel.rows[ri].toggleClass('hidden', si >= revealed);
    if (frame.rows[ri]) si++;
  }
  panel.node.attr('theme', frame.theme);
}

tick();
</script>
