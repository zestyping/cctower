<meta charset="utf-8">
<script src="jquery-3.6.1.slim.min.js"></script>
<script src="luxon.min.js"></script>

<style>
@font-face {
  font-family: frontpage;
  src: url('frontpageneue.otf') format('opentype');
}
@font-face {
  font-family: helveticacondensed;
  src: url('helveticacondensed.otf') format('opentype');
}
* {
  box-sizing: border-box;
}
body {
  margin: 0;
  padding: 0;
  background: #000;
  font-family: frontpage;
  font-size: 96px;
  line-height: 88px;
}
.percent {
  font-family: helveticacondensed;
  font-size: 90px;
  font-weight: 900;
}
#controls {
  position: absolute;
  right: 0;
  text-align: right;
  display: flex;
  flex-direction: column;
}
.spacer {
  height: 12px;
}
section {
  margin: 0;
  padding: 0;
  display: flex;
  position: absolute;
}
#upper {
  left: 0;
  top: 0;
}
#lower {
  left: 500;
  top: 0;
}
.simulation #upper {
  left: 208px;
  top: 0;
}
.simulation #lower {
  left: 0px;
  top: 832px;
}
.row {
  transition: opacity 250ms ease-out;
  white-space: pre;
}
.widget {
  white-space: normal;
}
.hidden {
  opacity: 0;
  transition: none;
}
.omitted {
  display: none;
}
.panel {
  padding: 12px 0 0 0;
  text-align: center;
}
.panel.left {
  background: #222;
}
.panel.right {
  background: #333;
}
.panel.upper {
  width: 208px;
  height: 832px;
}
.panel.lower {
  width: 416px;
  height: 1040px;
  overflow: hidden;
  color: white;
}
.panel .shade {
  position: absolute;
  top: 90%;
  bottom: 0;
  left: 0;
  right: 0;
  background: #000;
  opacity: 0.1;
  pointer-events: none;
}
.video {
  position: absolute;
  left: 0;
  top: 0;
}
#upper video {
  width: 416px;
  height: 832px;
}
#lower video {
  width: 832px;
  height: 1040px;
}
.digit {
  display: inline-block;
  width: 1ch;
  text-align: center;
}
.panel[theme='red'] {
  background: #eb1c23;
}
.panel[theme='blue'] {
  background: #4aa1cc;
}
.panel[theme='red-sm'] {
  background: #eb1c23;
  font-size: 78px;
}
.panel[theme='blue-sm'] {
  background: #4aa1cc;
  font-size: 78px;
}
.strike {
  text-decoration: line-through;
}
.time-part {
  text-align: left;
  padding-left: 84px;
}
.double {
  font-size: 200px;
  line-height: 200px;
  height: 176px;
}
.with-superscript {
  height: 88px;
  margin: -27px 0 27px 0;
}
.space-after {
  padding-bottom: 48px;
}
[theme='red'] .inverted {
  transition: opacity 750ms;
  color: #eb1c23;
  background: #fff;
}
[theme='blue'] .inverted {
  transition: opacity 750ms;
  color: #4aa1cc;
  background: #fff;
}
[theme='red'] .inverted.hidden {
  transition: none;
}
[theme='blue'] .inverted.hidden {
  transition: none;
}
.struck {
  display: inline-block;
  position: relative;
}
.striker {
  position: absolute;
  left: -10%;
  right: -10%;
  top: 43%;
  bottom: 43%;
  background: #eb1c23;
  transition: right 300ms ease-in 400ms;
}
.hidden .striker {
  right: 110%;
}
</style>

<body>
  <div id="controls">
    <button onclick="document.fullscreenElement ? document.exitFullscreen() : document.body.requestFullscreen()" type=button>Full screen</button>
    <div class="spacer"></div>
    <button onclick="si = -1; nextFrameMillis = Date.now()" type=button>Restart</button>
    <button onclick="si = (si + slides.length - 2) % slides.length; nextFrameMillis = Date.now()" type=button>Previous</button>
    <button onclick="nextFrameMillis = Date.now() + 3600*1000" type=button>Hold</button>
    <button onclick="nextFrameMillis = Date.now()" type=button>Next</button>
    <div class="spacer"></div>
    <button onclick="$('.shade').toggleClass('omitted')" type=button>Bottom 10%</button>
  </div>
  <section id=upper>
    <div class="video">
    </div>
    <div id="upper-left" class="panel upper left">
    </div>
    <div id="upper-right" class="panel upper right">
    </div>
  </section>

  <section id=lower>
    <div class="video">
    </div>
    <div id="lower-left" class="panel lower left">
      <div class="shade omitted"></div>
    </div>
    <div id="lower-right" class="panel lower right">
      <div class="shade omitted"></div>
    </div>
  </section>

  <div id="videos" class="omitted">
    <video id="clock" loop muted>
      <source src="clock.mp4" type="video/mp4">
    </video>
    <video id="lighthouse-upper" loop muted>
      <source src="lighthouse-upper.mp4" type="video/mp4">
    </video>
    <video id="lighthouse-lower" loop muted>
      <source src="lighthouse-lower.mp4" type="video/mp4">
    </video>
    <video id="stripes-upper" loop muted>
      <source src="stripes-upper.mp4" type="video/mp4">
    </video>
    <video id="stripes-lower" loop muted>
      <source src="stripes-lower.mp4" type="video/mp4">
    </video>
  </div>

  <div id="widgets" class="omitted">
    <div id="deadline-widget" class="widget">
      <div id="num-years" class="double"></div>
      <div id="label-years">YEARS</div>
      <div id="num-days" class="double">
        <span id="days-100" class="digit"></span><span id="days-10" class="digit"></span><span id="days-1" class="digit"></span>
      </div>
      <div id="label-days" class="space-after">DAYS</div>
      <div id="hours" class="time-part">
        <span id="hours-10" class="digit"></span><span id="hours-1" class="digit"></span> <span id="label-hours">HRS</span>
      </div>
      <div id="minutes" class="time-part">
        <span id="minutes-10" class="digit"></span><span id="minutes-1" class="digit"></span> <span id="label-minutes">MIN</span>
      </div>
      <div id="seconds" class="time-part">
        <span id="seconds-10" class="digit"></span><span id="seconds-1" class="digit"></span> <span id="label-seconds">SEC</span>
      </div>
    </div>

    <div id="renewables-widget" class="widget space-after">
      <div id="renewables-part1" class="double">
        <span id="renewables-10" class="digit"></span><span id="renewables-1" class="digit"></span>.
      </div>
      <div id="renewables-part2">
        <span id="renewables-01" class="digit"></span><span id="renewables-001" class="digit"></span><span id="renewables-0001" class="digit"></span><span id="renewables-00001" class="digit"></span><span id="renewables-000001" class="digit"></span>
      </div>
      <div id="renewables-part3">
        <span id="renewables-0000001" class="digit"></span><span id="renewables-00000001" class="digit"></span><span id="renewables-000000001" class="digit"></span><span id="renewables-0000000001" class="digit"></span><span class="percent">%</span>
      </div>
    </div>

    <div id="indigenous-land-widget" class="widget space-after">
      <div id="indigenous-part1" class="double">43.5</div>
      <div id="indigenous-part2" class="with-superscript">MILLION KM<sup>2</sup></div>
    </div>

    <div id="loss-damage-widget" class="widget space-after">
      <div id="loss-part1" class="double">
        $<span id="loss-10" class="digit"></span><span id="loss-1" class="digit"></span>.
      </div>
      <div id="loss-part2">
        <span id="loss-01" class="digit"></span><span id="loss-001" class="digit"></span><span id="loss-0001" class="digit"></span> <span id="loss-00001" class="digit"></span><span id="loss-000001" class="digit"></span><span id="loss-0000001" class="digit"></span>
      </div>
      <div id="loss-part3">
        <span id="loss-00000001" class="digit"></span><span id="loss-000000001" class="digit"></span><span id="loss-0000000001" class="digit"></span> <span id="loss-00000000001" class="digit"></span><span id="loss-000000000001" class="digit"></span><span id="loss-0000000000001" class="digit"></span>
      </div>
      <div id="loss-part4">TRILLION</div>
    </div>

  </div>
</body>

<script>
var clockVideo = $('video#clock');
var stripesUpperVideo = $('video#stripes-upper');
var stripesLowerVideo = $('video#stripes-lower');
var lighthouseUpperVideo = $('video#lighthouse-upper');
var lighthouseLowerVideo = $('video#lighthouse-lower');

var deadlineWidget = $('#deadline-widget');
var deadlineNumYears = $('#num-years');
var deadlineDays = [$('#days-1'), $('#days-10'), $('#days-100')];
var deadlineLabelDays = $('#label-days');
var deadlineHours = [$('#hours-1'), $('#hours-10')];
var deadlineLabelHours = $('#label-hours');
var deadlineMinutes = [$('#minutes-1'), $('#minutes-10')];
var deadlineSeconds = [$('#seconds-1'), $('#seconds-10')];

var renewablesWidget = $('#renewables-widget');
var renewablesWholePart = [$('#renewables-1'), $('#renewables-10')];
var renewablesFractionalPart = [
  $('#renewables-0000000001'),
  $('#renewables-000000001'),
  $('#renewables-00000001'),
  $('#renewables-0000001'),
  $('#renewables-000001'),
  $('#renewables-00001'),
  $('#renewables-0001'),
  $('#renewables-001'),
  $('#renewables-01'),
];

var indigenousLandWidget = $('#indigenous-land-widget');

var lossDamageWidget = $('#loss-damage-widget');
var lossDamageWholePart = [$('#loss-1'), $('#loss-10')];
var lossDamageFractionalPart = [
  $('#loss-0000000000001'),
  $('#loss-000000000001'),
  $('#loss-00000000001'),
  $('#loss-0000000001'),
  $('#loss-000000001'),
  $('#loss-00000001'),
  $('#loss-0000001'),
  $('#loss-000001'),
  $('#loss-00001'),
  $('#loss-0001'),
  $('#loss-001'),
  $('#loss-01'),
];

function setDigits(value, elements) {
  for (var element of elements) {
    element.text(value % 10);
    value = Math.floor(value / 10);
  }
}

const DEADLINE = luxon.DateTime.fromISO('2029-07-22T16:00:00Z');

function deadline(row) {
  if (row.children().length == 0) {
    row.append(deadlineWidget);
  }
  var now = luxon.DateTime.utc();
  var nextAnniversary = DEADLINE.set({year: now.year});
  if (nextAnniversary < now) {
    nextAnniversary = DEADLINE.set({year: now.year + 1});
  }
  var years = DEADLINE.year - nextAnniversary.year;
  var t = nextAnniversary.toMillis() - now.toMillis();
  t = Math.floor(t / 1000);
  var s = t % 60;
  t = Math.floor(t / 60);
  var m = t % 60;
  t = Math.floor(t / 60);
  var h = t % 24;
  var d = Math.floor(t / 24);

  deadlineNumYears.text(years);
  setDigits(d, deadlineDays);
  deadlineLabelDays.text((d == 1) ? 'DAY' : 'DAYS');
  setDigits(h, deadlineHours);
  deadlineLabelHours.text((h == 1) ? 'HR' : 'HRS');
  setDigits(m, deadlineMinutes);
  setDigits(s, deadlineSeconds);
}

function linearGrowth(spec) {
  var elapsed = BigInt(Date.now() - spec.refMillis);
  var value = spec.initial + spec.rate * elapsed / 1000n + spec.bias;
  var strValue = '0'.repeat(spec.shift) + String(value);
  var wholePart = strValue.substr(0, strValue.length - spec.shift);
  var fractionalPart = strValue.substr(-spec.shift).substr(0, spec.decimals);
  return wholePart.replace(/^0+/, '') + '.' + fractionalPart;
}

var RENEWABLES = {
  refMillis: luxon.DateTime.fromISO('2020-01-01T00:00:00Z').toMillis(),

  initial: 11400000000000000000000000n,
  rate: 20428359571070087n,

  decimals: 9,
  shift: 24
};
RENEWABLES.bias = 5n * 10n**BigInt(RENEWABLES.shift - RENEWABLES.decimals - 1);

function renewables(row) {
  if (row.children().length == 0) {
    row.append(renewablesWidget);
  }
  var value = linearGrowth(RENEWABLES);
  var [whole, fractional] = value.split('.');
  setDigits(whole - 0, renewablesWholePart);
  setDigits(fractional - 0, renewablesFractionalPart);
}

function indigenousLand(row) {
  if (row.children().length == 0) {
    row.append(indigenousLandWidget);
  }
}

var LOSS_DAMAGE = {
  refMillis: luxon.DateTime.fromISO('2020-01-01T00:00:00Z').toMillis(),

  initial: 297540000000000000000000n,
  rate: 471408520521309n,

  decimals: 12,
  shift: 22
};
LOSS_DAMAGE.bias = 5n * 10n**BigInt(LOSS_DAMAGE.shift - LOSS_DAMAGE.decimals - 1);

function lossAndDamage(row) {
  if (row.children().length == 0) {
    row.append(lossDamageWidget);
  }
  var value = linearGrowth(LOSS_DAMAGE);
  var [whole, fractional] = value.split('.');
  setDigits(whole - 0, lossDamageWholePart);
  setDigits(fractional - 0, lossDamageFractionalPart);
}

function double(text) {
  return (row) => {
    row.text(text);
    row.addClass('double');
  };
}

function spaceAfter(text) {
  return (row) => {
    row.text(text);
    row.addClass('space-after');
  };
}

function inverted(text) {
  return (row) => {
    row.text(text);
    row.addClass('inverted');
  };
}

function pause(row) {
  row.addClass('omitted');
}

function strike(text) {
  return (row) => {
    if (row.children().length == 0) {
      var span = $('<span>');
      span.addClass('struck');
      span.text(text);
      var striker = $('<div>');
      striker.addClass('striker');

      row.append(span);
      span.append(striker);
    }
  };
}

const DEFAULT_HOLD = 5;

var slides = [
  {
    duration: 60,
    left: {theme: '', beats: []},
    right: {theme: '', beats: []},
    video: {upper: lighthouseUpperVideo, lower: lighthouseLowerVideo}
  },

  {
    duration: 60,
    left: {theme: '', beats: []},
    right: {theme: '', beats: []},
    video: {upper: stripesUpperVideo, lower: stripesLowerVideo}
  },

  {
    duration: 10,
    left: {theme: 'red-sm', beats: ['#ClimateClock']},
    right: {theme: 'blue-sm', beats: ['#ActInTime']},
    video: {upper: clockVideo},
  },
  {
    left: {theme: 'red', beats: ['THE', 'SCIENCE', 'IS', 'CLEAR', pause]},
    right: {theme: 'blue', beats: ['OUR', 'CARBON', 'BUDGET', 'IS', 'RUNNING', 'OUT']}
  },
  {
    left: {theme: 'red', beats: ['WE', 'HAVE', 'LESS', 'THAN', '7', 'YEARS']},
    right: {theme: 'blue', beats: ['TO', 'PROTECT', 'OUR PLANET', '& PEOPLE']}
  },
  {
    left: {theme: 'red', beats: ['DELAY', '=', 'DENIAL', pause]},
    right: {theme: 'blue', beats: ['WE MUST', 'END', 'FOSSIL', 'FUELS', 'BY', strike('2070'), pause, strike('2050'), pause, strike('2040'), pause, double('2030')]}
  },
  {
    duration: 20,
    left: {theme: 'red', beats: [inverted('DEADLINE'), deadline, pause]},
    right: {theme: 'red', beats: ['THIS IS', 'OUR', 'WINDOW', 'OF', double('HOPE'), spaceAfter(' '), 'LET\'S', '#ActInTime']}
  },
  {
    left: {theme: 'red', beats: ['THE', 'EARTH', 'HAS A', 'DEADLINE']},
    right: {theme: 'blue', beats: ['BUT', 'WE HAVE', 'MANY', 'LIFELINES']}
  },
  {
    left: {theme: 'red', beats: ['SOLUTIONS', 'EXIST', pause]},
    right: {theme: 'blue', beats: ['WE CAN', 'BUILD A', 'JUST &', 'LIVABLE', 'WORLD']}
  },
  {
    left: {theme: 'red', beats: ['LEADERS', 'PRESIDENTS', 'MINISTERS', 'DELEGATES', 'BE', double('BOLD!'), pause]},
    right: {theme: 'blue', beats: ['THE', 'FUTURE', 'IS', 'COUNTING', 'ON', double('YOU')]}
  },
  {
    hold: 10,
    left: {theme: 'red', beats: ['THE EYES', 'OF THE', 'WORLD', 'ARE ON', 'COP27', pause]},
    right: {theme: 'blue', beats: ['NO MORE', strike('BLAH'), strike('BLAH'), strike('BLAH'), '', 'TIME FOR', pause, inverted('COURAGE'), pause, inverted('JUSTICE'), pause, inverted('SPEED')]}
  },
  {
    duration: 10,
    left: {theme: 'red-sm', beats: ['#ClimateClock']},
    right: {theme: 'blue-sm', beats: ['#ActInTime']}
  }
];

var loop = [
  {
    duration: 20,
    left: {theme: 'blue', beats: [inverted('LIFELINE'), renewables, 'OF WORLD\'S', 'ENERGY', 'COMES FROM', 'RENEWABLES', pause]},
    right: {theme: 'blue', beats: ['WE NEED', double('100%'), 'RENEWABLES', 'BEFORE', spaceAfter('2030'), 'TO STAY', 'BELOW', '1.5° C']}
  },
  {
    hold: 10,
    left: {theme: 'blue', beats: [inverted('LIFELINE'), indigenousLand, 'INDIGENOUS', 'LAND', 'MUST BE', 'PROTECTED', pause]},
    right: {theme: 'blue', beats: ['INDIGENOUS', 'LANDS IN', 'INDIGENOUS', 'HANDS', 'IS A KEY', 'CLIMATE', 'SOLUTION', '', '#LandBack']}
  },
  {
    duration: 20,
    left: {theme: 'blue', beats: [inverted('LIFELINE'), lossAndDamage, 'LOSS &', 'DAMAGE', 'OWED', 'BY G20', pause]},
    right: {theme: 'blue', beats: ['THE BIGGEST', 'POLLUTERS', 'MUST PAY', 'THOSE', 'MOST', 'IMPACTED']}
  },
  {
    duration: 30,
    left: {theme: 'red', beats: [inverted('DEADLINE'), deadline, pause]},
    right: {theme: 'red', beats: ['THIS IS', 'OUR', 'WINDOW', 'OF', double('HOPE'), spaceAfter(' '), 'LET\'S', '#ActInTime']}
  }
];

for (var i = 0; i < 4; i++) {
  slides = slides.concat(loop);
}


var si = -1;
var startFrameMillis = 0;
var nextFrameMillis = 0;
var bi = 0;
var panels = {
  left: {
    node: $('#lower-left'),
    rows: [],
  },
  right: {
    node: $('#lower-right'),
    rows: [],
  }
};

function tick() {
  var now = Date.now();
  var slide = slides[si];
  if (now > nextFrameMillis) {
    si = (si + 1) % slides.length;
    slide = slides[si];
    duration = (slide.duration * 1000) || (
        (1 + slide.left.beats.length + 1 + slide.right.beats.length) * 500 +
        (slide.hold || DEFAULT_HOLD) * 1000
    );
    startFrameMillis = (nextFrameMillis > now - 1000) ? nextFrameMillis : now;
    nextFrameMillis = startFrameMillis + duration;

    panels.left.node.attr('theme', slide.left.theme);
    panels.right.node.attr('theme', slide.right.theme);
    for (var ri = 0; ri < panels.left.rows.length; ri++) {
      panels.left.rows[ri].empty();
    }
    for (var ri = 0; ri < panels.right.rows.length; ri++) {
      panels.right.rows[ri].empty();
    }

    console.log('slide (' + duration/1000 + ' s):', slide.left.beats, slide.right.beats);
    if (slide.video) {
      $('#upper .video').empty();
      $('#lower .video').empty();
      if (slide.video.upper) {
        $('#upper .video').append(slide.video.upper);
        slide.video.upper.get(0).currentTime = 0;
        slide.video.upper.get(0).play();
      }
      if (slide.video.lower) {
        $('#lower .video').append(slide.video.lower);
        slide.video.lower.get(0).currentTime = 0;
        slide.video.lower.get(0).play();
      }
    }
  }
  bi = 1;
  drawPanel(panels.left, slide.left.beats, now - startFrameMillis);
  bi++;
  drawPanel(panels.right, slide.right.beats, now - startFrameMillis);
  setTimeout(tick, 20);
}

function drawPanel(panel, beats, millis) {
  while (panel.rows.length < beats.length) {
    panel.rows.push($('<div>').addClass('row').appendTo(panel.node));
  }
  var revealed = millis / 500;  /* each beat is 500 ms */
  for (var ri = 0; ri < panel.rows.length; ri++) {
    var content = beats[ri];
    if (typeof content == 'function') {
      content(panel.rows[ri]);
    } else {
      panel.rows[ri].empty();
      panel.rows[ri].removeClass().addClass('row');
      panel.rows[ri].text(content || ' ');
    }
    panel.rows[ri].toggleClass('hidden', bi >= revealed);
    if (ri < beats.length) bi++;
  }
}

tick();
</script>
